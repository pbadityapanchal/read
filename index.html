<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>FEELWORLD Teleprompter</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Space+Mono:wght@400;700&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet"/>
<style>
:root{
  --bg:#0a0a0c;--surface:#111115;--border:#1e1e26;
  --accent:#c6ec31;--accent-dim:rgba(198,236,49,0.15);
  --text:#e8e8f0;--dim:#555566;--red:#ff4444;
  --sb:300px; /* sidebar width */
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;}

/* ── TOPBAR ── */
.topbar{
  background:var(--surface);border-bottom:1px solid var(--border);
  height:52px;padding:0 16px;
  display:flex;align-items:center;gap:8px;
  position:relative;z-index:50;flex-shrink:0;
}
.brand{font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:3px;color:var(--accent);white-space:nowrap;}
.brand span{color:var(--dim);}
.mode-tabs{display:flex;background:var(--bg);border:1px solid var(--border);border-radius:7px;padding:3px;gap:3px;flex-shrink:0;}
.m-tab{padding:4px 10px;border:none;border-radius:5px;font-family:'Space Mono',monospace;font-size:9px;letter-spacing:1px;text-transform:uppercase;cursor:pointer;background:transparent;color:var(--dim);transition:all .2s;}
.m-tab.on{background:var(--accent);color:#000;font-weight:700;}
.topbar-mid{margin-left:auto;display:flex;align-items:center;gap:5px;flex-shrink:0;}
.ble-btn{display:flex;align-items:center;gap:6px;border:1px solid var(--border);background:transparent;color:var(--text);border-radius:6px;padding:4px 10px;font-family:'Space Mono',monospace;font-size:10px;cursor:pointer;transition:all .2s;}
.ble-btn:hover,.ble-btn.connected{border-color:var(--accent);color:var(--accent);}
.ble-btn.connected{background:var(--accent-dim);}
.ble-dot{width:7px;height:7px;border-radius:50%;background:var(--dim);transition:background .3s;flex-shrink:0;}
.ble-btn.connected .ble-dot{background:var(--accent);box-shadow:0 0 6px var(--accent);animation:blink 2s infinite;}
.ble-btn.scanning .ble-dot{background:#ffaa00;animation:blink .5s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.help-btn{background:transparent;border:1px solid var(--border);color:var(--dim);border-radius:5px;padding:4px 8px;font-family:'Space Mono',monospace;font-size:10px;cursor:pointer;}
.help-btn:hover{border-color:var(--accent);color:var(--accent);}

/* ── LAYOUT ── */
.layout{display:flex;height:calc(100vh - 52px);overflow:hidden;}

/* ── SIDEBAR ── */
.sidebar{
  width:var(--sb);flex-shrink:0;
  background:var(--surface);border-right:1px solid var(--border);
  display:flex;flex-direction:column;overflow-y:auto;overflow-x:hidden;
  transition:transform .3s;
}
.sb{padding:12px 14px;border-bottom:1px solid var(--border);}
.lbl{font-family:'Space Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--dim);text-transform:uppercase;margin-bottom:8px;}
textarea#scriptInput{width:100%;height:120px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;padding:8px;resize:none;outline:none;transition:border-color .2s;}
textarea#scriptInput:focus{border-color:var(--accent);}
textarea#scriptInput::placeholder{color:var(--dim);}
.brow{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap;}
.btn-a{background:var(--accent);border:none;color:#000;font-family:'Space Mono',monospace;font-size:10px;font-weight:700;padding:6px 12px;border-radius:5px;cursor:pointer;transition:opacity .2s;letter-spacing:1px;white-space:nowrap;}
.btn-a:hover{opacity:.85;}
.btn-g{background:transparent;border:1px solid var(--border);color:var(--dim);font-family:'Space Mono',monospace;font-size:10px;padding:6px 12px;border-radius:5px;cursor:pointer;transition:all .2s;white-space:nowrap;}
.btn-g:hover{border-color:var(--dim);color:var(--text);}

/* Speed */
.speed-num{font-family:'Bebas Neue',sans-serif;font-size:38px;color:var(--accent);line-height:1;letter-spacing:2px;}
.speed-unit{font-family:'Space Mono',monospace;font-size:9px;color:var(--dim);}
.speed-btns{display:flex;gap:4px;}
.spd-btn{width:34px;height:34px;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;user-select:none;-webkit-user-select:none;}
.spd-btn:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-dim);}
.spd-btn:active{transform:scale(.92);}
.fine-row{display:flex;align-items:center;gap:8px;margin-top:4px;}
.fine-lbl{font-size:10px;color:var(--dim);width:28px;flex-shrink:0;}
input[type=range]{flex:1;-webkit-appearance:none;height:3px;background:var(--border);border-radius:2px;outline:none;}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;background:var(--accent);border-radius:50%;cursor:pointer;box-shadow:0 0 0 3px var(--accent-dim);}

/* ETA display */
.eta-box{background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:8px 10px;margin-top:8px;}
.eta-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;}
.eta-lbl{font-family:'Space Mono',monospace;font-size:9px;color:var(--dim);letter-spacing:1px;}
.eta-val{font-family:'Space Mono',monospace;font-size:11px;color:var(--accent);}
.eta-progress{height:3px;background:var(--border);border-radius:2px;overflow:hidden;}
.eta-bar{height:100%;background:var(--accent);border-radius:2px;width:0%;transition:width .5s;}

/* Controls */
.ctrl-row{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
.ctrl-lbl{font-size:11px;color:var(--dim);width:76px;flex-shrink:0;}
.ctrl-val{font-family:'Space Mono',monospace;font-size:10px;color:var(--accent);width:34px;text-align:right;flex-shrink:0;}
.tog-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:7px;}
.tog-txt{font-size:12px;}
.tog{position:relative;width:36px;height:20px;}
.tog input{opacity:0;width:0;height:0;}
.tog .sl{position:absolute;cursor:pointer;inset:0;background:var(--border);border-radius:20px;transition:.3s;}
.tog .sl:before{content:'';position:absolute;width:14px;height:14px;left:3px;bottom:3px;background:var(--dim);border-radius:50%;transition:.3s;}
.tog input:checked+.sl{background:var(--accent-dim);border:1px solid var(--accent);}
.tog input:checked+.sl:before{transform:translateX(16px);background:var(--accent);}

/* Palette */
.palette{display:flex;gap:6px;flex-wrap:wrap;}
.swatch{width:28px;height:28px;border-radius:5px;cursor:pointer;border:2px solid transparent;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;transition:all .15s;}
.swatch:hover{transform:scale(1.12);}
.swatch.on{border-color:var(--accent)!important;box-shadow:0 0 8px var(--accent-dim);}

/* Ticker controls */
.ticker-controls{padding:12px 14px;border-bottom:1px solid var(--border);}
.mini-preview{position:relative;height:50px;background:#000;border-radius:6px;overflow:hidden;border:1px solid var(--border);margin-bottom:8px;}
.mini-line{position:absolute;left:0;right:0;height:2px;background:rgba(198,236,49,.5);}
.mini-mL{position:absolute;top:0;bottom:0;width:2px;background:rgba(255,100,100,.7);}
.mini-mR{position:absolute;top:0;bottom:0;width:2px;background:rgba(100,180,255,.7);}

/* Key map */
.remote-map{padding:12px 14px;flex:1;}
.key-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px;}
.key-item{background:var(--bg);border:1px solid var(--border);border-radius:5px;padding:5px 7px;display:flex;align-items:center;gap:5px;}
.kbadge{font-family:'Space Mono',monospace;font-size:8px;background:var(--accent-dim);color:var(--accent);border-radius:3px;padding:2px 4px;white-space:nowrap;flex-shrink:0;}
.kact{font-size:9px;color:var(--dim);}

/* ── PROMPTER AREA ── */
.prompter-area{
  flex:1;position:relative;overflow:hidden;
  background:#000;display:flex;flex-direction:column;
  min-width:0; /* prevent overflow */
}

/* VERTICAL */
.v-mode{flex:1;overflow:hidden;position:relative;}
.v-fade-t,.v-fade-b{position:absolute;left:0;right:0;height:80px;z-index:10;pointer-events:none;}
.v-fade-t{top:0;}.v-fade-b{bottom:0;}
.v-scroll{will-change:transform;padding:50vh 8% 50vh;}
.v-text{font-family:'DM Sans',sans-serif;font-size:52px;line-height:1.45;color:#fff;white-space:pre-wrap;word-break:break-word;}
.v-mode.mirror{transform:scaleX(-1);}

/* TICKER */
.t-mode{flex:1;position:relative;overflow:hidden;display:none;flex-direction:column;}
.t-mode.on{display:flex;}
.t-line-wrap{position:absolute;left:0;right:0;display:flex;align-items:center;overflow:hidden;height:110px;}
.t-line-wrap.mirror{transform:scaleX(-1);}
.t-fade-l,.t-fade-r{position:absolute;top:0;bottom:0;width:100px;z-index:5;pointer-events:none;}
.t-fade-l{left:0;}.t-fade-r{right:0;}
.marker-left,.marker-right{position:absolute;top:0;bottom:0;width:3px;z-index:20;cursor:ew-resize;}
.marker-left{background:rgba(255,90,90,.85);}.marker-right{background:rgba(90,180,255,.85);}
.marker-left::before,.marker-right::before{content:'';position:absolute;top:0;bottom:0;left:-10px;right:-10px;}
.marker-left::after{content:'L';position:absolute;top:4px;left:4px;font-family:'Space Mono',monospace;font-size:10px;color:rgba(255,90,90,.9);font-weight:700;}
.marker-right::after{content:'R';position:absolute;top:4px;right:4px;font-family:'Space Mono',monospace;font-size:10px;color:rgba(90,180,255,.9);font-weight:700;}
.marker-zone{position:absolute;top:0;bottom:0;background:rgba(255,255,255,.03);pointer-events:none;z-index:3;}
.t-track{white-space:nowrap;will-change:transform;display:flex;align-items:center;padding:0 100vw;}
.t-text{font-family:'DM Sans',sans-serif;font-size:80px;font-weight:500;color:#fff;white-space:nowrap;}
.t-word{display:inline-block;padding:0 16px;transition:color .1s;}
.t-word.lit{color:var(--accent);}
.t-sep{display:inline-block;width:10px;height:10px;border-radius:50%;background:var(--accent);margin:0 28px;vertical-align:middle;opacity:.35;}
.t-drag-handle{position:absolute;left:0;right:0;height:16px;cursor:ns-resize;background:rgba(198,236,49,.08);border-top:2px solid rgba(198,236,49,.35);z-index:30;display:flex;align-items:center;justify-content:center;}
.t-drag-handle::after{content:'drag';font-size:9px;color:rgba(198,236,49,.4);letter-spacing:2px;font-family:'Space Mono',monospace;}

/* ── CONTROL BAR — MOBILE RESPONSIVE ── */
.ctrl-bar{
  flex-shrink:0;
  background:rgba(0,0,0,.95);border-top:1px solid #1a1a1a;
  display:flex;align-items:center;padding:0 12px;gap:8px;
  position:relative;z-index:40;
  /* safe area for mobile notch */
  padding-bottom:env(safe-area-inset-bottom, 0px);
  min-height:56px;
}
.cbtn{
  width:44px;height:44px;border-radius:50%;flex-shrink:0;
  display:flex;align-items:center;justify-content:center;
  background:#1a1a1a;border:1px solid #2a2a2a;
  cursor:pointer;transition:all .2s;color:#fff;font-size:17px;
  /* bigger touch target */
  -webkit-tap-highlight-color:transparent;
  touch-action:manipulation;
}
.cbtn:hover{border-color:var(--accent);color:var(--accent);}
.cbtn.play{
  width:50px;height:50px;
  background:var(--accent);border-color:var(--accent);color:#000;font-size:20px;
}
.cbtn.play:hover{opacity:.85;}
.prog-area{flex:1;display:flex;flex-direction:column;gap:4px;min-width:0;}
.prog-wrap{height:4px;background:#1a1a1a;border-radius:2px;cursor:pointer;position:relative;}
.prog-fill{height:100%;background:var(--accent);border-radius:2px;width:0%;}
.time-row{display:flex;justify-content:space-between;align-items:center;}
.timer{font-family:'Space Mono',monospace;font-size:11px;color:var(--accent);letter-spacing:1px;}
.eta-inline{font-family:'Space Mono',monospace;font-size:10px;color:var(--dim);}
.eta-inline span{color:#aaa;}

/* Toast */
.toast-c{position:fixed;bottom:70px;right:12px;z-index:9999;}
.toast-m{background:#1a1a20;border:1px solid var(--border);border-left:3px solid var(--accent);color:var(--text);font-size:11px;padding:8px 12px;border-radius:5px;margin-top:5px;font-family:'Space Mono',monospace;animation:tslide .25s ease;max-width:220px;}
@keyframes tslide{from{transform:translateX(110%);opacity:0}to{transform:translateX(0);opacity:1}}

/* BLE Help + Debug */
.overlay-panel{position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:9999;display:none;align-items:center;justify-content:center;padding:16px;}
.overlay-panel.show{display:flex;}
.panel-box{background:#111115;border:1px solid var(--accent);border-radius:12px;max-width:480px;width:100%;padding:22px;max-height:90vh;overflow-y:auto;}
.panel-box h2{font-family:'Bebas Neue',sans-serif;font-size:20px;color:var(--accent);letter-spacing:2px;margin-bottom:14px;}
.ble-step{background:#0a0a0c;border-left:3px solid var(--accent);padding:9px 12px;border-radius:4px;margin-bottom:7px;font-size:12px;color:var(--text);line-height:1.7;}
.ble-step.err{border-left-color:#ff4444;}
.ble-step code{color:var(--accent);background:rgba(198,236,49,.1);padding:1px 5px;border-radius:3px;}
.step-tag{display:inline-block;background:rgba(198,236,49,.15);color:var(--accent);font-family:'Space Mono',monospace;font-size:8px;padding:2px 5px;border-radius:3px;margin-bottom:3px;letter-spacing:1px;}
.close-btn{margin-top:12px;width:100%;padding:9px;background:var(--accent);border:none;border-radius:6px;font-family:'Space Mono',monospace;font-size:11px;font-weight:700;cursor:pointer;color:#000;letter-spacing:1px;}

/* Scrollbar */
::-webkit-scrollbar{width:3px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border);}

/* ── RESPONSIVE MOBILE ── */
@media(max-width:640px){
  :root{ --sb:100%; }
  .sidebar{
    position:fixed;top:52px;left:0;right:0;bottom:0;z-index:100;
    width:100%;transform:translateX(-100%);
  }
  .sidebar.open{transform:translateX(0);}
  .topbar{padding:0 10px;gap:6px;}
  .brand{font-size:15px;letter-spacing:2px;}
  #bleStatusText{display:none;} /* hide text on mobile, keep dot */
  .ble-btn span{display:none;} /* hide text, show dot only */
  .ble-btn{padding:6px;min-width:32px;justify-content:center;}
  .ctrl-bar{padding:0 10px;gap:6px;}
  .timer{font-size:10px;}
}
</style>
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
  <div class="brand">FEEL<span>WORLD</span></div>

  <!-- Mobile: sidebar toggle -->
  <button class="btn-g" id="sidebarToggle" onclick="toggleSidebar()" style="padding:5px 10px;font-size:12px;display:none;">☰</button>

  <div class="mode-tabs" style="margin-left:8px;">
    <button class="m-tab on" id="tabV" onclick="setMode('v')">&#x2195; Vert</button>
    <button class="m-tab" id="tabT" onclick="setMode('t')">&#x2194; Ticker</button>
  </div>

  <div class="topbar-mid">
    <div class="ble-dot" id="gDot" style="display:none;"></div>
    <span id="gStatus" style="font-family:'Space Mono',monospace;font-size:10px;color:var(--dim);">BLE Off</span>
    <button class="ble-btn" id="bleBtn" onclick="toggleBLE()">
      <div class="ble-dot" id="bleDot"></div>
      <span id="bleTxt">Connect</span>
    </button>
    <button class="help-btn" onclick="showBLEHelp()" title="BLE Help">?</button>
  </div>
</div>

<!-- MAIN LAYOUT -->
<div class="layout">

  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">

    <!-- Script -->
    <div class="sb">
      <div class="lbl">Script</div>
      <textarea id="scriptInput" placeholder="Script yahan paste karo..."></textarea>
      <div class="brow">
        <button class="btn-a" onclick="loadScript()">&#9654; Load</button>
        <button class="btn-g" onclick="clearScript()">Clear</button>
        <button class="btn-g" onclick="toggleFS()">&#x26F6; Full</button>
        <button class="btn-g" id="sidebarClose" onclick="toggleSidebar()" style="display:none;">✕</button>
      </div>
    </div>

    <!-- Speed -->
    <div class="sb">
      <div class="lbl">Speed</div>
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
        <div>
          <div class="speed-num" id="speedNum">1.0</div>
          <div class="speed-unit">px/frame</div>
        </div>
        <div class="speed-btns">
          <div class="spd-btn" id="btnSlow">&#8722;</div>
          <div class="spd-btn" id="btnFast">+</div>
        </div>
      </div>
      <div class="fine-row">
        <div class="fine-lbl">Fine</div>
        <input type="range" id="speedSlider" min="1" max="100" value="10" step="1" oninput="setSpeedFromSlider(this.value)">
        <div class="ctrl-val" id="speedPct" style="width:36px;">10%</div>
      </div>
      <div class="brow" style="margin-top:6px;">
        <button class="btn-g" onclick="setSpeed(0.3)" style="padding:3px 7px;font-size:9px;">0.3</button>
        <button class="btn-g" onclick="setSpeed(0.5)" style="padding:3px 7px;font-size:9px;">0.5</button>
        <button class="btn-g" onclick="setSpeed(1.0)" style="padding:3px 7px;font-size:9px;">1.0</button>
        <button class="btn-g" onclick="setSpeed(2.0)" style="padding:3px 7px;font-size:9px;">2.0</button>
        <button class="btn-g" onclick="setSpeed(5.0)" style="padding:3px 7px;font-size:9px;">5.0</button>
      </div>

      <!-- ETA Box -->
      <div class="eta-box">
        <div class="eta-row">
          <span class="eta-lbl">ELAPSED</span>
          <span class="eta-val" id="etaElapsed">00:00</span>
        </div>
        <div class="eta-row">
          <span class="eta-lbl">REMAINING</span>
          <span class="eta-val" id="etaRemain">--:--</span>
        </div>
        <div class="eta-row" style="margin-bottom:6px;">
          <span class="eta-lbl">TOTAL EST.</span>
          <span class="eta-val" id="etaTotal">--:--</span>
        </div>
        <div class="eta-progress"><div class="eta-bar" id="etaBar"></div></div>
      </div>
    </div>

    <!-- Display -->
    <div class="sb">
      <div class="lbl">Display</div>
      <div class="ctrl-row">
        <div class="ctrl-lbl">Font Size</div>
        <input type="range" id="fontSlider" min="20" max="200" value="52" oninput="setFont(this.value)">
        <div class="ctrl-val" id="fontVal">52</div>
      </div>
      <div class="ctrl-row" id="mgRow">
        <div class="ctrl-lbl">Margin</div>
        <input type="range" id="mgSlider" min="0" max="20" value="8" oninput="setMg(this.value)">
        <div class="ctrl-val" id="mgVal">8%</div>
      </div>
      <div class="tog-row">
        <div class="tog-txt">Mirror</div>
        <label class="tog"><input type="checkbox" id="mirrorTog" onchange="onMirror()"><span class="sl"></span></label>
      </div>
      <div class="tog-row">
        <div class="tog-txt">Loop</div>
        <label class="tog"><input type="checkbox" id="loopTog"><span class="sl"></span></label>
      </div>
    </div>

    <!-- Ticker Controls -->
    <div class="ticker-controls" id="tickerCtrlSection" style="display:none;">
      <div class="lbl">Ticker Position</div>
      <div class="mini-preview" id="miniPreview">
        <div class="mini-line" id="miniLine" style="top:50%;"></div>
        <div class="mini-mL" id="miniML" style="left:10%;"></div>
        <div class="mini-mR" id="miniMR" style="left:85%;"></div>
        <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;">
          <span style="font-family:'Space Mono',monospace;font-size:8px;color:#333;">PREVIEW</span>
        </div>
      </div>
      <div class="ctrl-row">
        <div class="ctrl-lbl">Line Y</div>
        <input type="range" id="lineYSlider" min="5" max="90" value="50" oninput="setLineY(this.value)">
        <div class="ctrl-val" id="lineYVal">50%</div>
      </div>
      <div class="ctrl-row">
        <div class="ctrl-lbl" style="color:rgba(255,90,90,.9);">L Marker</div>
        <input type="range" id="markerLSlider" min="0" max="50" value="10" oninput="setMarkerL(this.value)">
        <div class="ctrl-val" id="markerLVal" style="color:rgba(255,90,90,.9);">10%</div>
      </div>
      <div class="ctrl-row">
        <div class="ctrl-lbl" style="color:rgba(90,180,255,.9);">R Marker</div>
        <input type="range" id="markerRSlider" min="50" max="100" value="85" oninput="setMarkerR(this.value)">
        <div class="ctrl-val" id="markerRVal" style="color:rgba(90,180,255,.9);">85%</div>
      </div>
    </div>

    <!-- Color -->
    <div class="sb">
      <div class="lbl">Color Theme</div>
      <div class="palette" id="palette"></div>
    </div>

    <!-- Key Map -->
    <div class="remote-map">
      <div class="lbl">Remote / Keyboard / Gamepad</div>
      <div class="key-grid">
        <div class="key-item" style="border-color:rgba(198,236,49,.4);">
          <span class="kbadge" style="background:rgba(198,236,49,.3);color:#000;">OK / Space</span>
          <span class="kact">Stop / Play</span>
        </div>
        <div class="key-item" style="border-color:rgba(255,180,0,.4);">
          <span class="kbadge" style="background:rgba(255,180,0,.2);color:#ffb400;">A / Enter</span>
          <span class="kact">Back to Start</span>
        </div>
        <div class="key-item" style="border-color:rgba(100,180,255,.4);">
          <span class="kbadge" style="background:rgba(100,180,255,.2);color:#64b4ff;">B / M</span>
          <span class="kact">Mirror</span>
        </div>
        <div class="key-item" style="border-color:rgba(255,100,100,.4);">
          <span class="kbadge" style="background:rgba(255,100,100,.2);color:#ff6464;">Y / F</span>
          <span class="kact">Fullscreen</span>
        </div>
        <div class="key-item" style="border-color:rgba(180,100,255,.4);">
          <span class="kbadge" style="background:rgba(180,100,255,.2);color:#b464ff;">X / C</span>
          <span class="kact">Next Color</span>
        </div>
        <div class="key-item">
          <span class="kbadge">&#x2191; / JOY&#x2191;</span>
          <span class="kact">Speed +</span>
        </div>
        <div class="key-item">
          <span class="kbadge">&#x2193; / JOY&#x2193;</span>
          <span class="kact">Speed −</span>
        </div>
        <div class="key-item">
          <span class="kbadge">&#x2192; / JOY&#x2192;</span>
          <span class="kact">Font +</span>
        </div>
        <div class="key-item">
          <span class="kbadge">&#x2190; / JOY&#x2190;</span>
          <span class="kact">Font −</span>
        </div>
        <div class="key-item">
          <span class="kbadge">R / Back</span>
          <span class="kact">Reset</span>
        </div>
        <div class="key-item">
          <span class="kbadge">T / Mode</span>
          <span class="kact">V↔Ticker</span>
        </div>
        <div class="key-item">
          <span class="kbadge">B4:0x10</span>
          <span class="kact">BLE Play</span>
        </div>
      </div>

      <!-- BLE Debug -->
      <div style="margin-top:8px;">
        <button class="btn-g" onclick="toggleBLEDebug()" style="width:100%;font-size:9px;padding:4px;">&#128269; BLE Debug (Y btn hex)</button>
        <div id="bleDebugPanel" style="display:none;margin-top:5px;background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:7px;max-height:180px;overflow-y:auto;">
          <div style="font-family:monospace;font-size:8px;color:var(--dim);margin-bottom:4px;">Y BUTTON DABAAO — HEX YAHAN</div>
          <div id="bleLogBody" style="color:var(--text);"></div>
        </div>
      </div>
    </div>

  </div><!-- /sidebar -->

  <!-- PROMPTER -->
  <div class="prompter-area" id="prompterArea">

    <!-- VERTICAL MODE -->
    <div class="v-mode" id="vMode">
      <div class="v-fade-t" id="vFadeT"></div>
      <div class="v-fade-b" id="vFadeB"></div>
      <div id="vScroll" style="will-change:transform;padding:50vh 8% 50vh;">
        <div class="v-text" id="vText">Apna script sidebar mein likho aur Load dabao.

Ticker tab se right-to-left ticker mode on karo.

FEELWORLD remote ya keyboard se full control milega.</div>
      </div>
    </div>

    <!-- TICKER MODE -->
    <div class="t-mode" id="tMode">
      <div class="t-drag-handle" id="tDragHandle"></div>
      <div class="t-line-wrap" id="tLineWrap">
        <div class="t-fade-l" id="tFadeL"></div>
        <div class="t-fade-r" id="tFadeR"></div>
        <div class="marker-left" id="markerL"></div>
        <div class="marker-right" id="markerR"></div>
        <div class="marker-zone" id="markerZone"></div>
        <div class="t-track" id="tTrack">
          <div class="t-text" id="tText">
            <span class="t-word">Script</span><span class="t-word">load</span><span class="t-word">karo</span>
          </div>
        </div>
      </div>
    </div>

    <!-- CONTROL BAR -->
    <div class="ctrl-bar" id="ctrlBar">
      <div class="cbtn play" id="playBtn" onclick="togglePlay()">&#9654;</div>
      <div class="cbtn" onclick="resetAll()" title="Reset (R)">&#x21BA;</div>
      <div class="prog-area">
        <div class="prog-wrap" id="progWrap" onclick="seekClick(event)">
          <div class="prog-fill" id="progFill"></div>
        </div>
        <div class="time-row">
          <span class="timer" id="timerEl">00:00:00</span>
          <span class="eta-inline">ETA <span id="etaCtrlRemain">--:--</span></span>
        </div>
      </div>
    </div>

  </div><!-- /prompter -->

</div><!-- /layout -->

<div class="toast-c" id="toastC"></div>

<!-- BLE HELP PANEL -->
<div class="overlay-panel" id="bleHelpPanel">
  <div class="panel-box">
    <h2>&#x1F4F1; BLE Remote Setup</h2>
    <div class="ble-step">
      <div class="step-tag">PC — CHROME</div><br>
      Web Bluetooth default on hai. "Connect" dabao.
    </div>
    <div class="ble-step">
      <div class="step-tag">ANDROID — CHROME FLAG</div><br>
      1. <code>chrome://flags</code> kholo<br>
      2. <code>Experimental Web Platform features</code> → Enabled<br>
      3. Chrome restart karo ✓
    </div>
    <div class="ble-step">
      <div class="step-tag">ANDROID — KIWI BROWSER</div><br>
      Kiwi Browser mein bina flag ke kaam karta hai. Play Store se install karo.
    </div>
    <div class="ble-step">
      <div class="step-tag">ANDROID 12+ PERMISSIONS</div><br>
      Settings → Apps → Browser → Permissions → Nearby devices ON karo.
    </div>
    <div class="ble-step err">
      <div class="step-tag" style="color:#ff6666;background:rgba(255,68,68,.1);">NOTE</div><br>
      HTTPS zaroori hai (GitHub Pages sahi hai). Android mein sirf browser support chahiye.
    </div>
    <button class="close-btn" onclick="hideBLEHelp()">BAND KARO</button>
  </div>
</div>

<script>
// ═══════════════════════════════════════════════
//  STATE
// ═══════════════════════════════════════════════
const S = {
  mode:'v', playing:false, speed:1.0, fontSize:52, mg:8,
  mirror:false, colorIdx:0,
  rafId:null, timerInterval:null, timer:0,
  vPos:0, tPos:0,
  tLineY:50, markerL:10, markerR:85,
  bleDevice:null, bleChar:null,
  totalFrames:0,  // estimated total frames for ETA
};
const SVC_UUID  = '00001000-e619-419b-bc43-821e71a409b7';
const CHAR_UUID = '00001002-e619-419b-bc43-821e71a409b7';
const COLORS = [
  {bg:'#000',text:'#fff',lbl:'A',lc:'#fff'},
  {bg:'#fff',text:'#000',lbl:'A',lc:'#000'},
  {bg:'#1a1a2e',text:'#e0e0ff',lbl:'A',lc:'#e0e0ff'},
  {bg:'#0d1f0d',text:'#7dff7d',lbl:'A',lc:'#7dff7d'},
  {bg:'#1f0d0d',text:'#ff9999',lbl:'A',lc:'#ff9999'},
];
const $ = id => document.getElementById(id);

// ═══════════════════════════════════════════════
//  MOBILE SIDEBAR TOGGLE
// ═══════════════════════════════════════════════
function isMobile() { return window.innerWidth <= 640; }
function toggleSidebar() {
  $('sidebar').classList.toggle('open');
}
function checkMobile() {
  const mob = isMobile();
  $('sidebarToggle').style.display = mob ? 'block' : 'none';
  $('sidebarClose').style.display  = mob ? 'block' : 'none';
  if (!mob) $('sidebar').classList.remove('open');
}
window.addEventListener('resize', checkMobile);
checkMobile();

// ═══════════════════════════════════════════════
//  SPEED
// ═══════════════════════════════════════════════
function setSpeed(v) {
  S.speed = Math.round(Math.min(10,Math.max(0.1,v))*10)/10;
  $('speedNum').textContent = S.speed.toFixed(1);
  $('speedSlider').value    = Math.round(S.speed*10);
  $('speedPct').textContent = Math.round(S.speed*10)+'%';
  calcETA();
}
function setSpeedFromSlider(v) { setSpeed(parseFloat(v)/10); }
let holdTimer=null, holdInterval=null;
function holdStart(dir) {
  const change = () => setSpeed(S.speed+dir*0.1);
  change();
  holdTimer = setTimeout(() => { holdInterval = setInterval(change,80); }, 400);
}
function holdEnd() { clearTimeout(holdTimer); clearInterval(holdInterval); }
$('btnFast').addEventListener('mousedown',  ()=>holdStart(+1));
$('btnFast').addEventListener('touchstart', ()=>holdStart(+1), {passive:true});
$('btnSlow').addEventListener('mousedown',  ()=>holdStart(-1));
$('btnSlow').addEventListener('touchstart', ()=>holdStart(-1), {passive:true});
['mouseup','mouseleave','touchend'].forEach(ev => document.addEventListener(ev, holdEnd));

// ═══════════════════════════════════════════════
//  ETA CALCULATION
// ═══════════════════════════════════════════════
function calcETA() {
  if (S.mode === 'v') {
    const max = $('vScroll').scrollHeight - $('vMode').clientHeight;
    S.totalFrames = max > 0 ? Math.ceil(max / S.speed) : 0;
  } else {
    const total = $('tTrack').scrollWidth / 2;
    S.totalFrames = total > 0 ? Math.ceil(total / S.speed) : 0;
  }
  const totalSec = S.totalFrames / 60; // assume ~60fps
  $('etaTotal').textContent = fmtMSS(totalSec);
  updateETA();
}

function updateETA() {
  const currentPos = S.mode === 'v' ? S.vPos : S.tPos;
  const maxPos = S.mode === 'v'
    ? ($('vScroll').scrollHeight - $('vMode').clientHeight)
    : ($('tTrack').scrollWidth / 2);

  const pct = maxPos > 0 ? currentPos / maxPos : 0;
  const totalSec = S.totalFrames / 60;
  const elapsedSec = pct * totalSec;
  const remainSec  = totalSec - elapsedSec;

  $('etaElapsed').textContent     = fmtMSS(elapsedSec);
  $('etaRemain').textContent      = remainSec > 0 ? fmtMSS(remainSec) : '00:00';
  $('etaCtrlRemain').textContent  = remainSec > 0 ? fmtMSS(remainSec) : '--:--';
  $('etaBar').style.width         = Math.min(100, pct*100)+'%';
}

function fmtMSS(totalSeconds) {
  if (!isFinite(totalSeconds) || totalSeconds <= 0) return '--:--';
  const m = Math.floor(totalSeconds / 60);
  const s = Math.floor(totalSeconds % 60);
  return String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
}

// ═══════════════════════════════════════════════
//  FONT / MARGIN
// ═══════════════════════════════════════════════
function setFont(v) {
  S.fontSize = parseInt(v);
  $('fontVal').textContent = v;
  $('vText').style.fontSize = v+'px';
  $('tText').style.fontSize = Math.max(30,v)+'px';
  $('tLineWrap').style.height = (parseInt(v)*1.5+20)+'px';
  positionTickerLine();
}
function setMg(v) {
  S.mg = parseInt(v);
  $('mgVal').textContent = v+'%';
  $('vScroll').style.paddingLeft  = v+'%';
  $('vScroll').style.paddingRight = v+'%';
}

// ═══════════════════════════════════════════════
//  MIRROR
// ═══════════════════════════════════════════════
function onMirror() {
  S.mirror = $('mirrorTog').checked;
  $('vMode').classList.toggle('mirror', S.mirror);
  $('tLineWrap').classList.toggle('mirror', S.mirror);
  // scroll direction stays -1, scaleX handles visual flip
  toast(S.mirror ? 'Mirror ON' : 'Mirror OFF');
}

// ═══════════════════════════════════════════════
//  COLORS
// ═══════════════════════════════════════════════
(function buildPalette() {
  const wrap = $('palette');
  COLORS.forEach((c,i) => {
    const s = document.createElement('div');
    s.className = 'swatch'+(i===0?' on':'');
    s.style.background = c.bg; s.style.color = c.lc;
    s.style.border = `2px solid ${c.lc}22`; s.textContent = c.lbl;
    s.onclick = () => applyColor(i);
    wrap.appendChild(s);
  });
})();
function applyColor(i) {
  S.colorIdx = i; const c = COLORS[i];
  $('prompterArea').style.background = c.bg;
  $('vText').style.color = c.text;
  $('tText').style.color = c.text;
  updateFades(c.bg);
  document.querySelectorAll('.swatch').forEach((s,j)=>s.classList.toggle('on',j===i));
}
function updateFades(bg) {
  $('vFadeT').style.background = `linear-gradient(to bottom,${bg},transparent)`;
  $('vFadeB').style.background = `linear-gradient(to top,${bg},transparent)`;
  $('tFadeL').style.background = `linear-gradient(to right,${bg},transparent)`;
  $('tFadeR').style.background = `linear-gradient(to left,${bg},transparent)`;
}

// ═══════════════════════════════════════════════
//  SCRIPT
// ═══════════════════════════════════════════════
function loadScript() {
  const txt = $('scriptInput').value.trim();
  if (!txt) { toast('Script khali hai!'); return; }
  $('vText').textContent = txt;
  buildTickerWords(txt);
  S.vPos = 0; S.tPos = 0;
  $('vScroll').style.transform = 'translateY(0)';
  updateProgress();
  // recalc ETA after content load (need slight delay for DOM reflow)
  setTimeout(calcETA, 100);
  toast('Script loaded ✓');
}
function clearScript() {
  $('scriptInput').value = '';
  $('vText').textContent = 'Script load karo...';
  $('tText').innerHTML = '<span class="t-word">Script</span><span class="t-word">load</span><span class="t-word">karo</span>';
  resetAll();
}
function buildTickerWords(txt) {
  const words = txt.replace(/\n+/g,' ').split(/\s+/).filter(Boolean);
  $('tText').innerHTML =
    words.map(w=>`<span class="t-word">${w}</span>`).join('') +
    `<span class="t-sep"></span>` +
    words.map(w=>`<span class="t-word">${w}</span>`).join('');
}

// ═══════════════════════════════════════════════
//  MODE
// ═══════════════════════════════════════════════
function setMode(m) {
  S.mode = m;
  $('tabV').classList.toggle('on', m==='v');
  $('tabT').classList.toggle('on', m==='t');
  $('vMode').style.display  = m==='v' ? 'block' : 'none';
  $('tMode').classList.toggle('on', m==='t');
  $('tickerCtrlSection').style.display = m==='t' ? 'block' : 'none';
  $('mgRow').style.display  = m==='v' ? 'flex' : 'none';
  if (m==='t') positionTickerLine();
  setTimeout(calcETA, 100);
  // Restart RAF if already playing (was in v3, keeps scroll going after mode switch)
  if (S.playing) { if(S.rafId!==null){cancelAnimationFrame(S.rafId);S.rafId=null;} startRAF(); }
}

// ═══════════════════════════════════════════════
//  TICKER LINE Y
// ═══════════════════════════════════════════════
function setLineY(pct) {
  S.tLineY = parseInt(pct);
  $('lineYVal').textContent = pct+'%';
  positionTickerLine(); updateMiniPreview();
}
function positionTickerLine() {
  const area   = $('prompterArea');
  const wrap   = $('tLineWrap');
  const handle = $('tDragHandle');
  const ctrlH  = $('ctrlBar').offsetHeight || 56;
  const areaH  = area.clientHeight - ctrlH;
  const wrapH  = wrap.offsetHeight || (S.fontSize*1.5+20);
  const top    = Math.round((S.tLineY/100)*areaH - wrapH/2);
  const final  = Math.max(0, Math.min(areaH-wrapH, top));
  wrap.style.top   = final+'px';
  handle.style.top = final+'px';
}
(function initLineDrag() {
  const handle = $('tDragHandle');
  let dragging=false, startY=0, startPct=50;
  function onDown(e) {
    if(S.mode!=='t') return; dragging=true;
    startY   = e.touches ? e.touches[0].clientY : e.clientY;
    startPct = S.tLineY; e.preventDefault();
  }
  function onMove(e) {
    if(!dragging) return;
    const cy    = e.touches ? e.touches[0].clientY : e.clientY;
    const areaH = $('prompterArea').clientHeight - ($('ctrlBar').offsetHeight||56);
    const newPct = Math.round(Math.max(5, Math.min(90, startPct+((cy-startY)/areaH)*100)));
    $('lineYSlider').value = newPct; setLineY(newPct);
  }
  function onUp() { dragging=false; }
  handle.addEventListener('mousedown', onDown);
  handle.addEventListener('touchstart', onDown, {passive:false});
  document.addEventListener('mousemove', onMove);
  document.addEventListener('touchmove', onMove, {passive:false});
  document.addEventListener('mouseup', onUp);
  document.addEventListener('touchend', onUp);
})();

// ═══════════════════════════════════════════════
//  MARKERS
// ═══════════════════════════════════════════════
function setMarkerL(pct) { S.markerL=parseInt(pct); $('markerLVal').textContent=pct+'%'; applyMarkers(); }
function setMarkerR(pct) { S.markerR=parseInt(pct); $('markerRVal').textContent=pct+'%'; applyMarkers(); }
function applyMarkers() {
  $('markerL').style.left     = S.markerL+'%';
  $('markerR').style.left     = S.markerR+'%';
  $('markerZone').style.left  = S.markerL+'%';
  $('markerZone').style.width = (S.markerR-S.markerL)+'%';
  updateMiniPreview();
}
function updateMiniPreview() {
  $('miniLine').style.top = S.tLineY+'%';
  $('miniML').style.left  = S.markerL+'%';
  $('miniMR').style.left  = S.markerR+'%';
}
(function initMarkerDrag() {
  function makeDraggable(el, isLeft) {
    let dragging=false;
    function onDown(e) { dragging=true; e.preventDefault(); e.stopPropagation(); }
    function onMove(e) {
      if(!dragging) return;
      const rect = $('tLineWrap').getBoundingClientRect();
      const cx   = e.touches ? e.touches[0].clientX : e.clientX;
      let pct    = Math.round(((cx-rect.left)/rect.width)*100);
      if(isLeft) { pct=Math.max(0,Math.min(S.markerR-5,pct)); $('markerLSlider').value=pct; setMarkerL(pct); }
      else       { pct=Math.max(S.markerL+5,Math.min(100,pct)); $('markerRSlider').value=pct; setMarkerR(pct); }
    }
    function onUp() { dragging=false; }
    el.addEventListener('mousedown', onDown);
    el.addEventListener('touchstart', onDown, {passive:false});
    document.addEventListener('mousemove', onMove);
    document.addEventListener('touchmove', onMove, {passive:false});
    document.addEventListener('mouseup', onUp);
    document.addEventListener('touchend', onUp);
  }
  makeDraggable($('markerL'), true);
  makeDraggable($('markerR'), false);
})();

// ═══════════════════════════════════════════════
//  PLAY / PAUSE — RAF with proper stop
// ═══════════════════════════════════════════════
let _lastToggle = 0;
function togglePlay() {
  const now = Date.now();
  if (now - _lastToggle < 250) return;
  _lastToggle = now;
  S.playing ? pauseAll() : playAll();
}
function playAll() {
  if (S.playing) return;
  S.playing = true;
  $('playBtn').innerHTML = '&#9646;&#9646;';
  $('playBtn').style.background   = 'var(--red)';
  $('playBtn').style.borderColor  = 'var(--red)';
  clearInterval(S.timerInterval);
  S.timerInterval = setInterval(()=>{ S.timer++; updateTimer(); }, 1000);
  startRAF();
}
function pauseAll() {
  S.playing = false;
  $('playBtn').innerHTML = '&#9654;';
  $('playBtn').style.background  = 'var(--accent)';
  $('playBtn').style.borderColor = 'var(--accent)';
  clearInterval(S.timerInterval);
  if (S.rafId !== null) { cancelAnimationFrame(S.rafId); S.rafId = null; }
}
function startRAF() {
  // Cancel existing RAF before starting — prevents double-loop on mobile
  if (S.rafId !== null) { cancelAnimationFrame(S.rafId); S.rafId = null; }
  function frame() {
    if (!S.playing) { S.rafId = null; return; }
    if (S.mode === 'v') scrollVertical();
    else scrollTicker();
    S.rafId = requestAnimationFrame(frame);
  }
  S.rafId = requestAnimationFrame(frame);
}

function scrollVertical() {
  S.vPos += S.speed;
  const track  = $('vScroll');
  const inner  = $('vMode');
  const maxPos = track.scrollHeight - inner.clientHeight;
  if (S.vPos >= maxPos) {
    if ($('loopTog').checked) { S.vPos = 0; S.timer = 0; }
    else { S.vPos = maxPos; pauseAll(); toast('Script khatam ✓'); return; }
  }
  track.style.transform = `translateY(-${S.vPos}px)`;
  updateProgress(); updateETA();
}

let litWord = null;
function scrollTicker() {
  S.tPos += S.speed;
  const track = $('tTrack');
  const total = track.scrollWidth / 2;
  if (S.tPos >= total) S.tPos = 0; // always loop ticker
  // tScrollDir is always -1 (mirror handled by CSS scaleX, not direction flip)
  track.style.transform = `translateX(${-1 * S.tPos}px)`;
  updateProgress(); updateETA(); highlightCenterWord();
}

function highlightCenterWord() {
  const wrap   = $('tLineWrap');
  const center = wrap.getBoundingClientRect().left + wrap.clientWidth/2;
  const words  = $('tText').querySelectorAll('.t-word');
  let closest=null, minDist=Infinity;
  words.forEach(w => {
    const r = w.getBoundingClientRect();
    const d = Math.abs(r.left + r.width/2 - center);
    if(d < minDist) { minDist=d; closest=w; }
  });
  if(litWord !== closest) {
    if(litWord) litWord.classList.remove('lit');
    if(closest) closest.classList.add('lit');
    litWord = closest;
  }
}

// ═══════════════════════════════════════════════
//  RESET / SEEK
// ═══════════════════════════════════════════════
// Back to start — dono modes mein, play state same rahe
function backToStart() {
  const wasPlaying = S.playing;
  // Pause RAF temporarily so transform sticks
  if (S.rafId !== null) { cancelAnimationFrame(S.rafId); S.rafId = null; }
  S.playing = false;

  S.vPos = 0; S.tPos = 0; S.timer = 0;
  $('vScroll').style.transform = 'translateY(0)';
  $('tTrack').style.transform  = 'translateX(0)';
  updateProgress(); updateTimer(); updateETA();

  // Resume if was playing
  if (wasPlaying) {
    S.playing = true;
    startRAF();
  }
  toast('↩ Back to start');
}
function resetAll() {
  pauseAll();
  S.vPos=0; S.tPos=0; S.timer=0;
  $('vScroll').style.transform = 'translateY(0)';
  $('tTrack').style.transform  = 'translateX(0)';
  updateProgress(); updateTimer(); updateETA();
}
function seekClick(e) {
  const rect = $('progWrap').getBoundingClientRect();
  const r    = Math.max(0, Math.min(1, (e.clientX-rect.left)/rect.width));
  if (S.mode === 'v') {
    const max = $('vScroll').scrollHeight - $('vMode').clientHeight;
    S.vPos = Math.floor(r*max);
    $('vScroll').style.transform = `translateY(-${S.vPos}px)`;
  } else {
    const total = $('tTrack').scrollWidth / 2;
    S.tPos = Math.floor(r*total);
    $('tTrack').style.transform = `translateX(${-1 * S.tPos}px)`;
  }
  updateProgress(); updateETA();
}
function updateProgress() {
  let pct=0;
  if (S.mode==='v') { const max=$('vScroll').scrollHeight-$('vMode').clientHeight; pct=max>0?(S.vPos/max)*100:0; }
  else              { const tot=$('tTrack').scrollWidth/2; pct=tot>0?(S.tPos/tot)*100:0; }
  $('progFill').style.width = Math.min(100,pct)+'%';
}
function updateTimer() {
  const h=Math.floor(S.timer/3600), m=Math.floor((S.timer%3600)/60), s=S.timer%60;
  $('timerEl').textContent = [h,m,s].map(n=>String(n).padStart(2,'0')).join(':');
}

// ═══════════════════════════════════════════════
//  FULLSCREEN — mobile compatible (document.documentElement)
// ═══════════════════════════════════════════════
function isFullscreen() {
  return !!(document.fullscreenElement || document.webkitFullscreenElement ||
            document.mozFullScreenElement || document.msFullscreenElement);
}

function toggleFS() {
  if (isFullscreen()) {
    // Exit fullscreen
    const fn = document.exitFullscreen || document.webkitExitFullscreen ||
               document.mozCancelFullScreen || document.msExitFullscreen;
    if (fn) fn.call(document);
    return;
  }
  // Enter fullscreen — try multiple elements, no .catch() toast on Android
  const targets = [document.documentElement, $('prompterArea'), document.body];
  for (const el of targets) {
    const fn = el.requestFullscreen || el.webkitRequestFullscreen ||
               el.mozRequestFullScreen || el.msRequestFullscreen;
    if (fn) {
      // Android tab: requestFullscreen must be triggered by user gesture
      // Remote se aane pe gesture nahi hoti — silently ignore, no error toast
      const p = fn.call(el);
      if (p && p.catch) p.catch(()=>{}); // silent fail, no toast
      return;
    }
  }
  // Fallback: CSS-based fake fullscreen for devices that dont support API
  toggleCSSFullscreen();
}

// CSS Fullscreen fallback — sidebar hide, prompter takes full screen
let _cssFS = false;
function toggleCSSFullscreen() {
  _cssFS = !_cssFS;
  const pa = $('prompterArea');
  const sb = $('sidebar');
  const tb = document.querySelector('.topbar');
  if (_cssFS) {
    pa.style.cssText = 'position:fixed;inset:0;z-index:9000;background:#000;display:flex;flex-direction:column;';
    sb.style.display = 'none';
    tb.style.display = 'none';
    toast('Fullscreen ON (CSS mode)');
  } else {
    pa.style.cssText = '';
    sb.style.display = '';
    tb.style.display = '';
    toast('Fullscreen OFF');
    checkMobile();
  }
  if (S.mode === 't') setTimeout(positionTickerLine, 50);
}

// Listen for native fullscreen change — hide/show sidebar accordingly
['fullscreenchange','webkitfullscreenchange','mozfullscreenchange','msfullscreenchange'].forEach(ev => {
  document.addEventListener(ev, () => {
    const inFS = isFullscreen();
    const sb = $('sidebar');
    const tb = document.querySelector('.topbar');
    if (inFS) {
      // Fullscreen: hide sidebar and topbar
      sb.setAttribute('data-fs-hidden', sb.style.display || '');
      tb.setAttribute('data-fs-hidden', tb.style.display || '');
      sb.style.display = 'none';
      tb.style.display = 'none';
    } else {
      // Exit fullscreen: restore
      sb.style.display = sb.getAttribute('data-fs-hidden') || '';
      tb.style.display = tb.getAttribute('data-fs-hidden') || '';
      sb.removeAttribute('data-fs-hidden');
      tb.removeAttribute('data-fs-hidden');
      checkMobile();
      if (S.mode === 't') setTimeout(positionTickerLine, 50);
    }
  });
});

// ═══════════════════════════════════════════════
//  KEYBOARD — full mapping: OK=Space, A=Enter, B=M, Y=F/Y, X=C, gamepad keys
// ═══════════════════════════════════════════════
document.addEventListener('keydown', e => {
  if (['INPUT','TEXTAREA'].includes(e.target.tagName)) return;
  switch(e.code) {
    // OK / Stop
    case 'Space': case 'Enter': case 'NumpadEnter':
      e.preventDefault(); togglePlay(); break;
    // Y → Fullscreen
    case 'KeyY': case 'KeyF':
      e.preventDefault(); toggleFS(); break;
    // B → Mirror
    case 'KeyB': case 'KeyM':
      $('mirrorTog').checked = !$('mirrorTog').checked; onMirror(); break;
    // A → Back to start (script beginning pe le jao, playing state same rahe)
    case 'KeyA':
      backToStart(); break;
    // X → Color
    case 'KeyX': case 'KeyC':
      applyColor((S.colorIdx+1)%COLORS.length); break;
    // Speed
    case 'ArrowUp':   e.preventDefault(); setSpeed(S.speed+0.1); break;
    case 'ArrowDown': e.preventDefault(); setSpeed(S.speed-0.1); break;
    // Font
    case 'ArrowRight': { e.preventDefault(); const nv=Math.min(200,S.fontSize+2); $('fontSlider').value=nv; setFont(nv); break; }
    case 'ArrowLeft':  { e.preventDefault(); const nv=Math.max(20, S.fontSize-2); $('fontSlider').value=nv; setFont(nv); break; }
    // Reset
    case 'KeyR': resetAll(); break;
    // Mode switch
    case 'KeyT': setMode(S.mode==='v'?'t':'v'); break;
    // Escape → exit fullscreen / close sidebar
    case 'Escape':
      if (document.fullscreenElement) toggleFS();
      else if ($('sidebar').classList.contains('open')) toggleSidebar();
      break;
  }
});

// ═══════════════════════════════════════════════
//  GAMEPAD SUPPORT (loop-based)
// ═══════════════════════════════════════════════
const GP = { prev: {} };
function gpLoop() {
  const pads = navigator.getGamepads ? navigator.getGamepads() : [];
  for (const gp of pads) {
    if (!gp) continue;
    const id = gp.index;
    if (!GP.prev[id]) GP.prev[id] = {};
    const p = GP.prev[id];

    function btn(i, fn) {
      const pressed = gp.buttons[i]?.pressed;
      if (pressed && !p[i]) fn();
      p[i] = pressed;
    }

    // Standard gamepad layout:
    // 0=A, 1=B, 2=X, 3=Y, 8=Select/Back, 9=Start
    btn(9,  togglePlay);                        // Start = Play/Stop
    btn(8,  resetAll);                          // Select/Back = Reset
    btn(0,  backToStart); // A = Back to start
    btn(1,  ()=>{ $('mirrorTog').checked=!$('mirrorTog').checked; onMirror(); });  // B = Mirror
    btn(3,  toggleFS);                          // Y = Fullscreen
    btn(2,  ()=>applyColor((S.colorIdx+1)%COLORS.length)); // X = Color

    // Axes: left stick
    const ax = gp.axes[1] ?? 0; // left stick Y
    const ax2 = gp.axes[0] ?? 0; // left stick X
    if (!p._axTimer) p._axTimer = 0;
    const now = Date.now();
    if (now - p._axTimer > 150) {
      if (ax < -0.5) { setSpeed(S.speed+0.1); p._axTimer=now; }
      if (ax > 0.5)  { setSpeed(S.speed-0.1); p._axTimer=now; }
      if (ax2 > 0.5) { const nv=Math.min(200,S.fontSize+2); $('fontSlider').value=nv; setFont(nv); p._axTimer=now; }
      if (ax2 < -0.5){ const nv=Math.max(20, S.fontSize-2); $('fontSlider').value=nv; setFont(nv); p._axTimer=now; }
    }
  }
  requestAnimationFrame(gpLoop);
}
requestAnimationFrame(gpLoop);

// ═══════════════════════════════════════════════
//  BLE PANELS
// ═══════════════════════════════════════════════
function showBLEHelp() { $('bleHelpPanel').classList.add('show'); }
function hideBLEHelp()  { $('bleHelpPanel').classList.remove('show'); }
$('bleHelpPanel').addEventListener('click', e => { if(e.target===$('bleHelpPanel')) hideBLEHelp(); });
function toggleBLEDebug() {
  const p=$('bleDebugPanel'); p.style.display=p.style.display==='none'?'block':'none';
}

// ═══════════════════════════════════════════════
//  BLE CONNECT — Android compatible
// ═══════════════════════════════════════════════
function isAndroid() { return /android/i.test(navigator.userAgent); }

async function toggleBLE() {
  if (S.bleDevice?.gatt?.connected) { disconnectBLE(); return; }
  if (!navigator.bluetooth) { showBLEHelp(); return; }
  try {
    setBLEStatus('scanning');
    let device;
    if (isAndroid()) {
      try { device = await navigator.bluetooth.requestDevice({filters:[{namePrefix:'FEELWORLD'}],optionalServices:[SVC_UUID]}); }
      catch { device = await navigator.bluetooth.requestDevice({acceptAllDevices:true,optionalServices:[SVC_UUID]}); }
    } else {
      try { device = await navigator.bluetooth.requestDevice({filters:[{services:[SVC_UUID]},{namePrefix:'FEELWORLD'}],optionalServices:[SVC_UUID]}); }
      catch(fe) {
        if(fe.name==='NotFoundError') device = await navigator.bluetooth.requestDevice({acceptAllDevices:true,optionalServices:[SVC_UUID]});
        else throw fe;
      }
    }
    S.bleDevice = device;
    device.addEventListener('gattserverdisconnected', onBLEDisc);
    const server = await device.gatt.connect();
    await new Promise(r=>setTimeout(r, isAndroid()?600:100));
    let svc;
    try { svc = await server.getPrimaryService(SVC_UUID); }
    catch { const all=await server.getPrimaryServices(); if(!all.length) throw new Error('No service'); svc=all[0]; }
    let ch;
    try { ch = await svc.getCharacteristic(CHAR_UUID); }
    catch { const all=await svc.getCharacteristics(); ch=all.find(c=>c.properties.notify)||all[0]; }
    S.bleChar = ch;
    if (ch.properties.notify) { await ch.startNotifications(); ch.addEventListener('characteristicvaluechanged',onBLEData); }
    setBLEStatus('connected', device.name||'Remote');
    toast('Connected: '+(device.name||'Remote'));
  } catch(e) {
    setBLEStatus('disconnected');
    if(['NotFoundError','AbortError'].includes(e.name)||e.message?.includes('cancel')) { toast('Cancelled'); return; }
    if(['SecurityError','NotSupportedError'].includes(e.name)) { showBLEHelp(); }
    else { toast('BLE: '+(e.message||e.name)); console.error('BLE:',e); }
  }
}
function disconnectBLE() {
  S.bleDevice?.gatt?.disconnect();
  S.bleDevice=null; S.bleChar=null;
  setBLEStatus('disconnected'); toast('Remote disconnected');
}
function onBLEDisc() {
  S.bleDevice=null; S.bleChar=null;
  setBLEStatus('disconnected'); toast('Remote disconnected');
}
function setBLEStatus(st, name) {
  const btn=$('bleBtn');
  btn.className='ble-btn'+(st==='connected'?' connected':st==='scanning'?' scanning':'');
  $('bleTxt').textContent  = st==='connected'?(name||'OK'):st==='scanning'?'Scan...':'Connect';
  $('gStatus').textContent = st==='connected'?'● '+(name||'OK'):st==='scanning'?'Scanning...':'BLE Off';
  $('gStatus').style.color = st==='connected'?'var(--accent)':st==='scanning'?'#ffaa00':'var(--dim)';
  const dc = st==='connected'?'var(--accent)':st==='scanning'?'#ffaa00':'var(--dim)';
  $('gDot').style.background=$('bleDot').style.background=dc;
}

// ═══════════════════════════════════════════════
//  BLE DATA — Android APK mapping + Y button
// ═══════════════════════════════════════════════
function onBLEData(ev) {
  const raw = new Uint8Array(ev.target.value.buffer);
  const d   = raw.slice(2);
  if(d.length < 6) return;
  bleLog(raw);

  if (d[0]===0x80 && d[1]===0x80) {
    // REMOTE MODE — APK mapping
    switch(d[4]) {
      case 0x10: togglePlay(); break;
      case 0x40: applyColor((S.colorIdx+1)%COLORS.length); break;
      case 0x80: toggleFS(); break;    // Lock btn → Fullscreen
      case 0x20: resetAll(); break;    // Back btn → Reset
    }
    switch(d[5]) {
      case 0x02: $('mirrorTog').checked=!$('mirrorTog').checked; onMirror(); break;
      case 0x08: $('loopTog').checked=!$('loopTog').checked; toast('Loop: '+($('loopTog').checked?'ON':'OFF')); break;
      case 0x04: setMode(S.mode==='v'?'t':'v'); break;
      // Y button candidates (debug log se confirm karo actual value)
      case 0x01: case 0x10: case 0x20: case 0x40: toggleFS(); break;
    }
    // d[3] bhi check — kuch remotes yahan bhejte hain
    if(d[3] && d[3]!==0x00) {
      switch(d[3]) {
        case 0x01: case 0x02: case 0x04: case 0x08:
        case 0x10: case 0x40: case 0x80: toggleFS(); break;
      }
    }
  } else {
    // JOYSTICK MODE
    const x=d[0]&0xFF, y=d[1]&0xFF;
    if(y===0x00) setSpeed(S.speed+0.1);
    if(y===0xFF) setSpeed(S.speed-0.1);
    if(x>192&&y>64&&y<192) { const nv=Math.min(200,S.fontSize+2); $('fontSlider').value=nv; setFont(nv); }
    if(x<64&&y>64&&y<192)  { const nv=Math.max(20, S.fontSize-2); $('fontSlider').value=nv; setFont(nv); }
  }
}

const bleHistory=[];
function bleLog(raw) {
  const hex = Array.from(raw).map(b=>'0x'+b.toString(16).padStart(2,'0').toUpperCase()).join(' ');
  const d   = Array.from(raw.slice(2));
  bleHistory.unshift({
    hex, mode:(d[0]===0x80&&d[1]===0x80)?'REMOTE':'JOY',
    d3:'0x'+(d[3]||0).toString(16).padStart(2,'0').toUpperCase(),
    d4:'0x'+(d[4]||0).toString(16).padStart(2,'0').toUpperCase(),
    d5:'0x'+(d[5]||0).toString(16).padStart(2,'0').toUpperCase(),
    time: new Date().toLocaleTimeString()
  });
  if(bleHistory.length>12) bleHistory.pop();
  const el=$('bleLogBody'); if(!el) return;
  el.innerHTML=bleHistory.map(e=>
    `<div style="border-bottom:1px solid #1a1a22;padding:4px 0;font-size:10px;">
      <span style="color:var(--accent);font-family:monospace;">[${e.time}] ${e.mode}</span><br>
      <span style="color:#777;font-size:9px;">${e.hex}</span><br>
      <span style="color:#aaa;font-family:monospace;font-size:10px;">d[3]:<b style="color:#fff">${e.d3}</b> d[4]:<b style="color:#fff">${e.d4}</b> d[5]:<b style="color:#fff">${e.d5}</b></span>
    </div>`
  ).join('');
}

// ═══════════════════════════════════════════════
//  TOAST
// ═══════════════════════════════════════════════
function toast(msg) {
  const c=$('toastC'), d=document.createElement('div');
  d.className='toast-m'; d.textContent=msg; c.appendChild(d);
  setTimeout(()=>d.remove(), 2800);
}

// ═══════════════════════════════════════════════
//  INIT
// ═══════════════════════════════════════════════
setSpeed(1.0); setFont(52); setMg(8); applyColor(0);
applyMarkers(); updateMiniPreview(); setMode('v');
if(isAndroid()&&!navigator.bluetooth) setTimeout(()=>toast('Android: ? dabao BLE setup ke liye'),1500);
window.addEventListener('resize', ()=>{
  checkMobile();
  if(S.mode==='t') positionTickerLine();
  setTimeout(calcETA, 100);
});
</script>
</body>
</html>
